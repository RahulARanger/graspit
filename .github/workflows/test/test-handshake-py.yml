name: 'server-build'

on:
  workflow_dispatch:
  push:
    branches:
      - build
    paths:
      - "handshake/*"
      - ".github/scripts/save-env.py"
      - "**test-handshake-py.yml"


permissions:
    contents: write

jobs:
    test:
      name: check if the build is stable
      runs-on: ${{ matrix.os }}

      strategy:
        matrix:
          os: ['macos-latest', 'windows-latest', 'ubuntu-latest']

      steps:
        - uses: actions/checkout@v4

        - name: If in ubuntu, Install sqlite3 3.45.0
          if: ${{ matrix.os == 'ubuntu-latest' }}
          run: |
            bash ./.github/scripts/build-sqlite.sh

        - name: Set up Python 3.11
          uses: actions/setup-python@v5
          with:
            python-version: |
              3.11
              3.12

        - name: Set up venv
          run: |
            python -m venv venv

        - name: Activate venv if not Windows
          if: ${{ matrix.os != 'windows-latest' }}
          run: | 
            source ./venv/bin/activate

        - name: Activate venv if Windows
          if: ${{ matrix.os == 'windows-latest' }}
          run: ./venv/scripts/activate

        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install poetry nox
            poetry install

        - name: Regression Test
          run: nox -s test

#        - name: Build env file
#          env:
#            ENV_FILE: ${{ secrets.PROD_ENV }}
#          run:
#            python ./.github/scripts/save-env.py
